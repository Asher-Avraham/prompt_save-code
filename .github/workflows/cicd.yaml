name: Full CI/CD Pipeline

on:
  push:
    branches: ["main", "feature/*"]
  pull_request:
    branches: ["main"]

env:
  BACKEND_REPO: PLACEHOLDER_BACKEND
  FRONTEND_REPO: PLACEHOLDER_FRONTEND
  AWS_REGION: ap-south-1
  GITOPS_REPO: PLACEHOLDER_GITOPS

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Backend Unit Tests
        run: |
          cd backend
          npm ci
          npm test

      - name: Frontend Unit Tests
        run: |
          cd frontend
          npm ci
          npm test

      - name: Start Integration Stack
        if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
        run: |
          docker compose -f compose.test.yml up -d --build --wait --quiet-pull

      - name: Run Integration Tests
        if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
        run: |
          npm ci
          TEST_BASE_URL=http://localhost:80 npm run test:integration

      - name: Stop and Cleanup
        if: always()
        run: docker compose -f compose.test.yml down -v

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
#   build-and-push:
#     needs: [test, security]
#     if: github.ref == 'refs/heads/main'
#     runs-on: ubuntu-latest
#     permissions:
#       id-token: write
#       contents: read
#     steps:
#       - uses: actions/checkout@v4

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           role-to-assume: arn:aws:iam::PLACEHOLDER_AWS_ACCOUNT:role/github-actions-role
#           aws-region: ${{env.AWS_REGION}}

#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{secrets.DOCKERHUB_USERNAME}}
#           password: ${{secrets.DOCKERHUB_TOKEN}}

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Build and Push Backend
#         uses: docker/build-push-action@v6
#         with:
#           context: ./backend
#           push: true
#           tags: ${{env.BACKEND_REPO}}:${{github.sha}}
#           cache-from: type=gha
#           cache-to: type=gha, mode=max

#       - name: Build and Push Frontend
#         uses: docker/build-push-action@v6
#         with:
#           context: ./frontend
#           push: true
#           tags: ${{env.FRONTEND_REPO}}:${{github.sha}}
#           cache-from: type=gha
#           cache-to: type=gha, mode=max

#   gitops-deploy:
#     needs: build-and-push
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout Gitops Repo
#         uses: actions/checkout@v4
#         with:
#           repository: ${{env.GITOPS_REPO}}
#           token: ${{secrets.GITOPS_PAT}}

#       - name: Update K8s manifest -kustomize
#         run: |
#           cd overlays/production
#           kustomize edit set image backend-api=${{env.BACKEND_REPO}}:${{github.sha}}
#           kustomize edit set image frontend-ui=${{env.FRONTEND_REPO}}:${{github.sha}}

#       - name: Commit and Push to GitOps Repo
#         run: |
#           git config user.name "github-actions[bot]"
#           git config user.email "github-actions[bot]@user.noreply.github.com"
#           git add .
#           git commit -m "chore: update frontend and backend to ${{github.sha}}"
#           git push
